import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import fetch from 'node-fetch';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;

// Middleware
app.use(cors());
app.use(express.json());

// ORDS Configuration
const ORDS_BASE_URL = process.env.ORDS_BASE_URL || 'https://your-apex-url.oraclecloud.com/ords/admin/statefarm';
const ORDS_AUTH = process.env.ORDS_AUTH || ''; // Optional: Basic Auth if needed

// Helper function to call ORDS
async function callORDS(endpoint, options = {}) {
  try {
    const url = `${ORDS_BASE_URL}${endpoint}`;
    console.log(`[ORDS] Calling: ${url}`);
    
    const headers = {
      'Content-Type': 'application/json',
      ...options.headers
    };
    
    // Add auth if provided
    if (ORDS_AUTH) {
      headers['Authorization'] = `Basic ${ORDS_AUTH}`;
    }
    
    const response = await fetch(url, {
      method: options.method || 'GET',
      headers,
      body: options.body ? JSON.stringify(options.body) : undefined
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`ORDS Error ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    console.log(`[ORDS] Success. Items:`, data.items?.length || 'N/A');
    
    return data;
  } catch (error) {
    console.error('[ORDS] Error:', error.message);
    throw error;
  }
}

// Health check endpoint
app.get('/health', async (req, res) => {
  try {
    // Try to call ORDS to verify connection
    await callORDS('/dashboard/summary');
    res.json({ 
      status: 'healthy', 
      backend: 'connected',
      ords: 'connected',
      timestamp: new Date().toISOString()
    });
  } catch (err) {
    res.status(500).json({ 
      status: 'unhealthy', 
      backend: 'connected',
      ords: 'disconnected',
      error: err.message 
    });
  }
});

// Get Claims
app.get('/api/claims', async (req, res) => {
  try {
    const data = await callORDS('/claims/all');
    res.json(data.items || []);
  } catch (err) {
    console.error('Error fetching claims:', err);
    res.status(500).json({ error: err.message });
  }
});

// Get Single Claim
app.get('/api/claims/:id', async (req, res) => {
  try {
    const data = await callORDS(`/claims/${req.params.id}`);
    res.json(data);
  } catch (err) {
    console.error('Error fetching claim:', err);
    res.status(500).json({ error: err.message });
  }
});

// Get Adjusters
app.get('/api/adjusters', async (req, res) => {
  try {
    const data = await callORDS('/adjusters/all');
    res.json(data.items || []);
  } catch (err) {
    console.error('Error fetching adjusters:', err);
    res.status(500).json({ error: err.message });
  }
});

// Get Damages
app.get('/api/damages', async (req, res) => {
  try {
    const data = await callORDS('/damages/all');
    res.json(data.items || []);
  } catch (err) {
    console.error('Error fetching damages:', err);
    res.status(500).json({ error: err.message });
  }
});

// Get AI Insights
app.get('/api/ai-insights', async (req, res) => {
  try {
    const data = await callORDS('/ai-insights/all');
    res.json(data.items || []);
  } catch (err) {
    console.error('Error fetching AI insights:', err);
    res.json([]); // Return empty array on error
  }
});

// Get Dashboard Data
app.get('/api/dashboard', async (req, res) => {
  try {
    // Fetch all dashboard data in parallel
    const [
      summaryResponse,
      statusResponse,
      trendResponse,
      damageTypesResponse,
      adjustersResponse
    ] = await Promise.all([
      callORDS('/dashboard/summary'),
      callORDS('/dashboard/claims-by-status'),
      callORDS('/dashboard/claims-trend'),
      callORDS('/dashboard/top-damage-types'),
      callORDS('/dashboard/top-adjusters')
    ]);
    
    // Combine all dashboard data
    const dashboardData = {
      ...summaryResponse,
      claimsByStatus: statusResponse.items || [],
      claimsTrend: trendResponse.items || [],
      topDamageTypes: damageTypesResponse.items || [],
      topAdjusters: adjustersResponse.items || []
    };
    
    res.json(dashboardData);
  } catch (err) {
    console.error('Error fetching dashboard:', err);
    res.status(500).json({ error: err.message });
  }
});

// Start server
app.listen(PORT, () => {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                                                                          â•‘');
  console.log('â•‘         ðŸš€ State Farm Backend Server (ORDS Architecture)                â•‘');
  console.log('â•‘                                                                          â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');
  console.log(`ðŸ“Š Server running: http://localhost:${PORT}`);
  console.log(`ðŸ”— Health check: http://localhost:${PORT}/health`);
  console.log(`ðŸ“¡ API Base: http://localhost:${PORT}/api`);
  console.log(`ðŸŒ ORDS Base: ${ORDS_BASE_URL}`);
  console.log('');
  console.log('Architecture: Frontend -> Express Backend -> ORDS -> Oracle Database');
  console.log('');
  console.log('Available endpoints:');
  console.log('  âœ“ GET /api/claims');
  console.log('  âœ“ GET /api/adjusters');
  console.log('  âœ“ GET /api/damages');
  console.log('  âœ“ GET /api/ai-insights');
  console.log('  âœ“ GET /api/dashboard');
  console.log('');
});

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\nðŸ›‘ Shutting down gracefully...');
  process.exit(0);
});
